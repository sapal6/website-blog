<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Satyabrata pal">
<meta name="dcterms.date" content="2021-10-12">

<title>Satyabrata pal - Extending-Fastai-For-Custom-Task</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-6WXK83Q2S1"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-6WXK83Q2S1', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Satyabrata pal</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">Blog</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../series.html">Series</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/sapal6"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/thecodingprojec"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/channel/UCNWi3qvLjYdSAqKnt1uZj-w"><i class="bi bi-youtube" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Extending-Fastai-For-Custom-Task</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Deep Learning</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Satyabrata pal </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 12, 2021</p>
    </div>
  </div>
    
  </div>
  

</header>

<section id="what-is-this" class="level2">
<h2 class="anchored" data-anchor-id="what-is-this">What is this? ü§î</h2>
<p>Experiment to weave nnaudio, timm and fastai together</p>
</section>
<section id="what-i-have-tried-to-explore-here" class="level2">
<h2 class="anchored" data-anchor-id="what-i-have-tried-to-explore-here">What I have tried to explore here? üîç</h2>
<p>üëâ Extend Fastai for signal processing and time series:</p>
<pre><code>* To use nnAudio for faster processing than librosa or other signal/audio processing methods.
* To deal with time series data as images.
* To deal with cosmological data like gravitational waves.1</code></pre>
<p>üëâ Create custom Transform.</p>
<p>üëâ Create custom block.</p>
<p>üëâ Create a dataloader.</p>
<p>üëâ Create a custom model with models from the timm library.</p>
<p>üëâ Create custom learner.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:38:56.545640Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:38:56.466750Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:38:56.572797Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:38:56.573224Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:00:52.319686Z&quot;}" data-papermill="{&quot;duration&quot;:0.187521,&quot;end_time&quot;:&quot;2021-10-01T09:38:56.573475&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:38:56.385954&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>reload_ext autoreload</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>autoreload <span class="dv">2</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="installing-all-the-required-libraries" class="level2">
<h2 class="anchored" data-anchor-id="installing-all-the-required-libraries">Installing all the required libraries‚öôÔ∏è</h2>
<p>üëâ Spacy</p>
<p>üëâ Fastai</p>
<p>üëâ nnAudio</p>
<p>üëâ timm</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:38:56.891945Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:38:56.891149Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:38:56.915871Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:38:56.915429Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:00:52.453769Z&quot;}" data-papermill="{&quot;duration&quot;:0.105598,&quot;end_time&quot;:&quot;2021-10-01T09:38:56.915991&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:38:56.810393&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!pip install spacy==3.1.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:38:57.074554Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:38:57.073802Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:42:33.772598Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:42:33.772085Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:00:52.483065Z&quot;}" data-papermill="{&quot;duration&quot;:216.779078,&quot;end_time&quot;:&quot;2021-10-01T09:42:33.772766&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:38:56.993688&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!pip3 install torch==1.9.0 torchvision==0.10.0</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip3 install torch<span class="op">==</span><span class="fl">1.9.0</span><span class="op">+</span>cu111 torchvision<span class="op">==</span><span class="fl">0.10.0</span><span class="op">+</span>cu111 torchaudio<span class="op">==</span><span class="fl">0.9.0</span> <span class="op">-</span>f https:<span class="op">//</span>download.pytorch.org<span class="op">/</span>whl<span class="op">/</span>torch_stable.html</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Looking in links: https://download.pytorch.org/whl/torch_stable.html
Collecting torch==1.9.0+cu111
  Downloading https://download.pytorch.org/whl/cu111/torch-1.9.0%2Bcu111-cp37-cp37m-linux_x86_64.whl (2041.3 MB)
     |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 2041.3 MB 3.1 kB/s 
Collecting torchvision==0.10.0+cu111
  Downloading https://download.pytorch.org/whl/cu111/torchvision-0.10.0%2Bcu111-cp37-cp37m-linux_x86_64.whl (23.2 MB)
     |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 23.2 MB 28.8 MB/s 
Collecting torchaudio==0.9.0
  Downloading torchaudio-0.9.0-cp37-cp37m-manylinux1_x86_64.whl (1.9 MB)
     |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 1.9 MB 607 kB/s 
Requirement already satisfied: typing-extensions in /opt/conda/lib/python3.7/site-packages (from torch==1.9.0+cu111) (3.7.4.3)
Requirement already satisfied: numpy in /opt/conda/lib/python3.7/site-packages (from torchvision==0.10.0+cu111) (1.19.5)
Requirement already satisfied: pillow&gt;=5.3.0 in /opt/conda/lib/python3.7/site-packages (from torchvision==0.10.0+cu111) (8.2.0)
Installing collected packages: torch, torchvision, torchaudio
  Attempting uninstall: torch
    Found existing installation: torch 1.7.1+cu110
    Uninstalling torch-1.7.1+cu110:
      Successfully uninstalled torch-1.7.1+cu110
  Attempting uninstall: torchvision
    Found existing installation: torchvision 0.8.2+cu110
    Uninstalling torchvision-0.8.2+cu110:
      Successfully uninstalled torchvision-0.8.2+cu110
  Attempting uninstall: torchaudio
    Found existing installation: torchaudio 0.7.2
    Uninstalling torchaudio-0.7.2:
      Successfully uninstalled torchaudio-0.7.2
ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
torchtext 0.8.1 requires torch==1.7.1, but you have torch 1.9.0+cu111 which is incompatible.
fastai 2.2.7 requires torch&lt;1.8,&gt;=1.7.0, but you have torch 1.9.0+cu111 which is incompatible.
fastai 2.2.7 requires torchvision&lt;0.9,&gt;=0.8, but you have torchvision 0.10.0+cu111 which is incompatible.
Successfully installed torch-1.9.0+cu111 torchaudio-0.9.0 torchvision-0.10.0+cu111
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</code></pre>
</div>
</div>
<p>::: {.cell _kg_hide-input=‚Äòtrue‚Äô _kg_hide-output=‚Äòtrue‚Äô execution=‚Äò{‚Äúiopub.execute_input‚Äù:‚Äú2021-10-01T09:42:35.698110Z‚Äù,‚Äúiopub.status.busy‚Äù:‚Äú2021-10-01T09:42:35.697293Z‚Äù,‚Äúiopub.status.idle‚Äù:‚Äú2021-10-01T09:42:46.806039Z‚Äù,‚Äúshell.execute_reply‚Äù:‚Äú2021-10-01T09:42:46.805491Z‚Äù,‚Äúshell.execute_reply.started‚Äù:‚Äú2021-10-01T09:04:05.909260Z‚Äù}‚Äô papermill=‚Äò{‚Äúduration‚Äù:12.087095,‚Äúend_time‚Äù:‚Äú2021-10-01T09:42:46.806171‚Äù,‚Äúexception‚Äù:false,‚Äústart_time‚Äù:‚Äú2021-10-01T09:42:34.719076‚Äù,‚Äústatus‚Äù:‚Äúcompleted‚Äù}‚Äô tags=‚Äò[]‚Äô execution_count=4}</p>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!yes Y|conda install -c fastai fastai=2.5.2</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip3 install fastai<span class="op">==</span><span class="fl">2.5.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Collecting fastai==2.5.2
  Downloading fastai-2.5.2-py3-none-any.whl (186 kB)
     |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 186 kB 15 kB/s 
Requirement already satisfied: scipy in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (1.7.1)
Requirement already satisfied: packaging in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (21.0)
Requirement already satisfied: pyyaml in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (5.4.1)
Requirement already satisfied: matplotlib in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (3.4.3)
Requirement already satisfied: requests in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (2.25.1)
Requirement already satisfied: pip in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (21.2.4)
Requirement already satisfied: torchvision&gt;=0.8.2 in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (0.10.0+cu111)
Requirement already satisfied: pillow&gt;6.0.0 in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (8.2.0)
Collecting fastdownload&lt;2,&gt;=0.0.5
  Downloading fastdownload-0.0.5-py3-none-any.whl (13 kB)
Requirement already satisfied: spacy&lt;4 in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (2.3.7)
Requirement already satisfied: scikit-learn in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (0.23.2)
Requirement already satisfied: torch&lt;1.10,&gt;=1.7.0 in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (1.9.0+cu111)
Requirement already satisfied: pandas in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (1.2.5)
Requirement already satisfied: fastprogress&gt;=0.2.4 in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (1.0.0)
Requirement already satisfied: fastcore&lt;1.4,&gt;=1.3.8 in /opt/conda/lib/python3.7/site-packages (from fastai==2.5.2) (1.3.26)
Requirement already satisfied: numpy in /opt/conda/lib/python3.7/site-packages (from fastprogress&gt;=0.2.4-&gt;fastai==2.5.2) (1.19.5)
Requirement already satisfied: blis&lt;0.8.0,&gt;=0.4.0 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (0.7.4)
Requirement already satisfied: murmurhash&lt;1.1.0,&gt;=0.28.0 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (1.0.5)
Requirement already satisfied: preshed&lt;3.1.0,&gt;=3.0.2 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (3.0.5)
Requirement already satisfied: wasabi&lt;1.1.0,&gt;=0.4.0 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (0.8.2)
Requirement already satisfied: thinc&lt;7.5.0,&gt;=7.4.1 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (7.4.5)
Requirement already satisfied: plac&lt;1.2.0,&gt;=0.9.6 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (1.1.3)
Requirement already satisfied: cymem&lt;2.1.0,&gt;=2.0.2 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (2.0.5)
Requirement already satisfied: setuptools in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (57.4.0)
Requirement already satisfied: catalogue&lt;1.1.0,&gt;=0.0.7 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (1.0.0)
Requirement already satisfied: tqdm&lt;5.0.0,&gt;=4.38.0 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (4.62.1)
Requirement already satisfied: srsly&lt;1.1.0,&gt;=1.0.2 in /opt/conda/lib/python3.7/site-packages (from spacy&lt;4-&gt;fastai==2.5.2) (1.0.5)
Requirement already satisfied: importlib-metadata&gt;=0.20 in /opt/conda/lib/python3.7/site-packages (from catalogue&lt;1.1.0,&gt;=0.0.7-&gt;spacy&lt;4-&gt;fastai==2.5.2) (3.4.0)
Requirement already satisfied: zipp&gt;=0.5 in /opt/conda/lib/python3.7/site-packages (from importlib-metadata&gt;=0.20-&gt;catalogue&lt;1.1.0,&gt;=0.0.7-&gt;spacy&lt;4-&gt;fastai==2.5.2) (3.5.0)
Requirement already satisfied: typing-extensions&gt;=3.6.4 in /opt/conda/lib/python3.7/site-packages (from importlib-metadata&gt;=0.20-&gt;catalogue&lt;1.1.0,&gt;=0.0.7-&gt;spacy&lt;4-&gt;fastai==2.5.2) (3.7.4.3)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /opt/conda/lib/python3.7/site-packages (from requests-&gt;fastai==2.5.2) (1.26.6)
Requirement already satisfied: chardet&lt;5,&gt;=3.0.2 in /opt/conda/lib/python3.7/site-packages (from requests-&gt;fastai==2.5.2) (4.0.0)
Requirement already satisfied: certifi&gt;=2017.4.17 in /opt/conda/lib/python3.7/site-packages (from requests-&gt;fastai==2.5.2) (2021.5.30)
Requirement already satisfied: idna&lt;3,&gt;=2.5 in /opt/conda/lib/python3.7/site-packages (from requests-&gt;fastai==2.5.2) (2.10)
Requirement already satisfied: pyparsing&gt;=2.2.1 in /opt/conda/lib/python3.7/site-packages (from matplotlib-&gt;fastai==2.5.2) (2.4.7)
Requirement already satisfied: kiwisolver&gt;=1.0.1 in /opt/conda/lib/python3.7/site-packages (from matplotlib-&gt;fastai==2.5.2) (1.3.1)
Requirement already satisfied: python-dateutil&gt;=2.7 in /opt/conda/lib/python3.7/site-packages (from matplotlib-&gt;fastai==2.5.2) (2.8.0)
Requirement already satisfied: cycler&gt;=0.10 in /opt/conda/lib/python3.7/site-packages (from matplotlib-&gt;fastai==2.5.2) (0.10.0)
Requirement already satisfied: six in /opt/conda/lib/python3.7/site-packages (from cycler&gt;=0.10-&gt;matplotlib-&gt;fastai==2.5.2) (1.15.0)
Requirement already satisfied: pytz&gt;=2017.3 in /opt/conda/lib/python3.7/site-packages (from pandas-&gt;fastai==2.5.2) (2021.1)
Requirement already satisfied: joblib&gt;=0.11 in /opt/conda/lib/python3.7/site-packages (from scikit-learn-&gt;fastai==2.5.2) (1.0.1)
Requirement already satisfied: threadpoolctl&gt;=2.0.0 in /opt/conda/lib/python3.7/site-packages (from scikit-learn-&gt;fastai==2.5.2) (2.2.0)
Installing collected packages: fastdownload, fastai
  Attempting uninstall: fastai
    Found existing installation: fastai 2.2.7
    Uninstalling fastai-2.2.7:
      Successfully uninstalled fastai-2.2.7
Successfully installed fastai-2.5.2 fastdownload-0.0.5
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</code></pre>
</div>
<p>:::</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:42:48.716907Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:42:48.716329Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:42:57.167868Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:42:57.166933Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:04:15.012505Z&quot;}" data-papermill="{&quot;duration&quot;:9.41224,&quot;end_time&quot;:&quot;2021-10-01T09:42:57.168010&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:42:47.755770&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip3 install timm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Collecting timm
  Downloading timm-0.4.12-py3-none-any.whl (376 kB)
     |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 376 kB 607 kB/s 
Requirement already satisfied: torchvision in /opt/conda/lib/python3.7/site-packages (from timm) (0.10.0+cu111)
Requirement already satisfied: torch&gt;=1.4 in /opt/conda/lib/python3.7/site-packages (from timm) (1.9.0+cu111)
Requirement already satisfied: typing-extensions in /opt/conda/lib/python3.7/site-packages (from torch&gt;=1.4-&gt;timm) (3.7.4.3)
Requirement already satisfied: numpy in /opt/conda/lib/python3.7/site-packages (from torchvision-&gt;timm) (1.19.5)
Requirement already satisfied: pillow&gt;=5.3.0 in /opt/conda/lib/python3.7/site-packages (from torchvision-&gt;timm) (8.2.0)
Installing collected packages: timm
Successfully installed timm-0.4.12
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:42:59.055673Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:42:59.054872Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:43:06.308125Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:43:06.307562Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:04:22.811880Z&quot;}" data-papermill="{&quot;duration&quot;:8.200742,&quot;end_time&quot;:&quot;2021-10-01T09:43:06.308255&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:42:58.107513&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip3 install nnaudio</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Collecting nnaudio
  Downloading nnAudio-0.2.6-py3-none-any.whl (30 kB)
Installing collected packages: nnaudio
Successfully installed nnaudio-0.2.6
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</code></pre>
</div>
</div>
</section>
<section id="import-all-required-modules" class="level2">
<h2 class="anchored" data-anchor-id="import-all-required-modules">Import all required modulesüñ•Ô∏è</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:43:10.071274Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:43:10.070406Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:43:12.901932Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:43:12.901421Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:04:30.265649Z&quot;}" data-papermill="{&quot;duration&quot;:3.776142,&quot;end_time&quot;:&quot;2021-10-01T09:43:12.902074&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:43:09.125932&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> namedtuple</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nnAudio.Spectrogram <span class="im">import</span> CQT</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> timm <span class="im">import</span> create_model, list_models</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.core.frame <span class="im">import</span> DataFrame</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.foundation <span class="im">import</span> <span class="op">*</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.torch_core <span class="im">import</span> show_image</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.learner <span class="im">import</span> _update_first_layer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="get-the-files" class="level2">
<h2 class="anchored" data-anchor-id="get-the-files">Get the filesüèóÔ∏è</h2>
<p>I will try to grab all the numpy files inside train folder</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:43:16.624045Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:43:16.623223Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:43:16.665213Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:43:16.664711Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:04:33.139175Z&quot;}" data-papermill="{&quot;duration&quot;:0.973764,&quot;end_time&quot;:&quot;2021-10-01T09:43:16.665350&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:43:15.691586&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">"../input"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="get-labels" class="level3">
<h3 class="anchored" data-anchor-id="get-labels">Get labelsüèóÔ∏è</h3>
<p>Training labels are in the ‚Äòtraining_labels.csv‚Äô file.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:43:20.438161Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:43:20.437410Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:43:20.823245Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:43:20.822246Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:04:33.212365Z&quot;}" data-papermill="{&quot;duration&quot;:1.359852,&quot;end_time&quot;:&quot;2021-10-01T09:43:20.823386&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:43:19.463534&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'g2net-gravitational-wave-detection/training_labels.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:43:22.913372Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:43:22.912529Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:43:22.971088Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:43:22.971486Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:04:33.744909Z&quot;}" data-papermill="{&quot;duration&quot;:1.225638,&quot;end_time&quot;:&quot;2021-10-01T09:43:22.971625&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:43:21.745987&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>id</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>00000e74ad</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
</section>
<section id="getfilespath-path-ext" class="level2">
<h2 class="anchored" data-anchor-id="getfilespath-path-ext">getfiles(path: Path, ext)</h2>
<p>Get numpy files in <code>path</code> recursively, only in <code>folders</code>, if specified.</p>
<blockquote class="blockquote">
<p>The ‚Äú#export‚Äù in the function below and all the rest of the functions/code are there to help me use nbdev to export the required code into a library later.</p>
</blockquote>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:43:26.746451Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:43:26.745612Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:43:26.779860Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:43:26.780227Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:04:33.811055Z&quot;}" data-papermill="{&quot;duration&quot;:1.006944,&quot;end_time&quot;:&quot;2021-10-01T09:43:26.780383&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:43:25.773439&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> getfiles(path: Path, ext) <span class="op">-&gt;</span> L:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get numpy files in `path` recursively, only in `folders`, if specified."</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L(path.glob(<span class="ss">f'**/*.</span><span class="sc">{</span>ext<span class="sc">}</span><span class="ss">'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I am using the previous function to get all the files under the train folder.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:43:31.069529Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:43:31.068612Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:43:31.106901Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:43:31.106458Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:04:33.853413Z&quot;}" data-papermill="{&quot;duration&quot;:1.101897,&quot;end_time&quot;:&quot;2021-10-01T09:43:31.107030&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:43:30.005133&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="12">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>train_path <span class="op">=</span> path<span class="op">/</span><span class="st">'g2net-gravitational-wave-detection/train'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:43:32.988636Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:43:32.987842Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:45:35.388858Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:45:35.389479Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:04:33.892954Z&quot;}" data-papermill="{&quot;duration&quot;:123.362642,&quot;end_time&quot;:&quot;2021-10-01T09:45:35.389688&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:43:32.027046&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>train_files <span class="op">=</span> getfiles(train_path, <span class="st">"npy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 5.74 s, sys: 2.23 s, total: 7.97 s
Wall time: 2min 1s</code></pre>
</div>
</div>
<p>Just a quick test to see if we got the correct files.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:45:39.698395Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:45:39.697512Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:45:39.740570Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:45:39.740155Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:19.800983Z&quot;}" data-papermill="{&quot;duration&quot;:1.510079,&quot;end_time&quot;:&quot;2021-10-01T09:45:39.740726&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:45:38.230647&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>train_files[:<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>(#2) [Path('../input/g2net-gravitational-wave-detection/train/7/7/7/777d746e90.npy'),Path('../input/g2net-gravitational-wave-detection/train/7/7/7/777ecfbd65.npy')]</code></pre>
</div>
</div>
<p>Picking labels from the dataframe. We may need these labels later.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:45:43.623558Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:45:43.622726Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:45:43.674748Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:45:43.675157Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:19.845785Z&quot;}" data-papermill="{&quot;duration&quot;:0.988765,&quot;end_time&quot;:&quot;2021-10-01T09:45:43.675308&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:45:42.686543&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> df.target.to_list()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="map-path-to-labels" class="level2">
<h2 class="anchored" data-anchor-id="map-path-to-labels">Map path to labelsüó∫Ô∏è</h2>
<p>To make things easier I will try to map the file paths to their respective labels and create a datafrane out of it.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:45:47.649911Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:45:47.649081Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:45:47.688794Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:45:47.688289Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:19.899274Z&quot;}" data-papermill="{&quot;duration&quot;:0.977258,&quot;end_time&quot;:&quot;2021-10-01T09:45:47.688967&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:45:46.711709&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map_path_to_labels(data: L, cols: L<span class="op">=</span><span class="va">None</span> ) <span class="op">-&gt;</span> DataFrame:</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""maps the files to their labels"""</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cols <span class="kw">is</span> <span class="va">None</span>: <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"You forgot to provide the columns"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(cols, data))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame.from_dict(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:45:49.614450Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:45:49.610414Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:45:51.727711Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:45:51.728094Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:19.940760Z&quot;}" data-papermill="{&quot;duration&quot;:3.079305,&quot;end_time&quot;:&quot;2021-10-01T09:45:51.728245&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:45:48.648940&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> map_path_to_labels([train_files, labels], cols<span class="op">=</span>[<span class="st">"id"</span>, <span class="st">"target"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.07 s, sys: 0 ns, total: 2.07 s
Wall time: 2.07 s</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:45:53.611382Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:45:53.610589Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:45:53.654868Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:45:53.655271Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:22.121645Z&quot;}" data-papermill="{&quot;duration&quot;:0.977578,&quot;end_time&quot;:&quot;2021-10-01T09:45:53.655495&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:45:52.677917&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="18">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>id</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>../input/g2net-gravitational-wave-detection/train/7/7/7/777d746e90.npy</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="mapxydf" class="level2">
<h2 class="anchored" data-anchor-id="mapxydf">mapxy(df)</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:45:57.616651Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:45:57.615772Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:45:57.654544Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:45:57.654140Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:22.174400Z&quot;}" data-papermill="{&quot;duration&quot;:1.095784,&quot;end_time&quot;:&quot;2021-10-01T09:45:57.654677&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:45:56.558893&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="19">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mapxy(df: DataFrame):</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a dictionary of file path and the label from a dataframe"""</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(df.values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:45:59.555896Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:45:59.555045Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:00.464911Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:00.465345Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:22.218681Z&quot;}" data-papermill="{&quot;duration&quot;:1.859472,&quot;end_time&quot;:&quot;2021-10-01T09:46:00.465494&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:45:58.606022&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="20">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> mapxy(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 872 ms, sys: 0 ns, total: 872 ms
Wall time: 872 ms</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:02.347883Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:02.347250Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:02.391725Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:02.392170Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:23.234763Z&quot;}" data-papermill="{&quot;duration&quot;:0.985177,&quot;end_time&quot;:&quot;2021-10-01T09:46:02.392332&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:01.407155&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="21">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>files[train_files[<span class="dv">7</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 11 ¬µs, sys: 7 ¬µs, total: 18 ¬µs
Wall time: 21.5 ¬µs</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>1</code></pre>
</div>
</div>
</section>
<section id="get_labelf-path" class="level2">
<h2 class="anchored" data-anchor-id="get_labelf-path">get_label(f: Path)</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:06.126187Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:06.124462Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:06.167916Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:06.168359Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:23.298090Z&quot;}" data-papermill="{&quot;duration&quot;:0.979043,&quot;end_time&quot;:&quot;2021-10-01T09:46:06.168512&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:05.189469&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_label(f: Path):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""get the label belonging to a file"""</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    label <span class="op">=</span> <span class="va">None</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> f <span class="kw">in</span> df.values:</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> df[df[<span class="st">'id'</span>] <span class="op">==</span> f][<span class="st">'target'</span>].values[<span class="dv">0</span>]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> label</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:08.282748Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:08.281790Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:09.163609Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:09.164278Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:23.360251Z&quot;}" data-papermill="{&quot;duration&quot;:2.064649,&quot;end_time&quot;:&quot;2021-10-01T09:46:09.164438&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:07.099789&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="23">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>get_label(train_files[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>1</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:11.055758Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:11.053882Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:11.628856Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:11.629395Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:24.362308Z&quot;}" data-papermill="{&quot;duration&quot;:1.514773,&quot;end_time&quot;:&quot;2021-10-01T09:46:11.629617&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:10.114844&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>get_label(Path(<span class="st">"/ff/ff.npy"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="q-transform-using-nnaudio" class="level2">
<h2 class="anchored" data-anchor-id="q-transform-using-nnaudio">Q transform using nnaudio‚öóÔ∏è</h2>
<p>We will design a function that would get the q transform of the time series on the fly using nnaudio. The result will be similar to converting the time series data into images.</p>
<p>Code taken from <a href="https://www.kaggle.com/yasufuminakama/g2net-efficientnet-b7-baseline-training">notebook</a> shared by <a href="https://www.kaggle.com/yasufuminakama">Y.Nakama</a></p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:15.798420Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:15.797586Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:15.839178Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:15.838741Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:24.876416Z&quot;}" data-papermill="{&quot;duration&quot;:0.974233,&quot;end_time&quot;:&quot;2021-10-01T09:46:15.839302&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:14.865069&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> qtfm():</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""convert waves to images"""</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    cqt <span class="op">=</span> CQT(sr<span class="op">=</span> <span class="dv">2048</span>, fmin<span class="op">=</span> <span class="dv">20</span>, fmax<span class="op">=</span> <span class="dv">1024</span>, hop_length<span class="op">=</span> <span class="dv">32</span>, bins_per_octave<span class="op">=</span><span class="dv">8</span>,verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cqt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>NOTE</strong></p>
<p>Remember to set <code>verbose</code> False if you don‚Äôt want all the string output to be displayed everytime dataloader loads the data.</p>
<p>Quick test to see if this works.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:21.724126Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:21.723386Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:21.781980Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:21.781493Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:24.923367Z&quot;}" data-papermill="{&quot;duration&quot;:1.023866,&quot;end_time&quot;:&quot;2021-10-01T09:46:21.782103&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:20.758237&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="26">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>waves <span class="op">=</span> np.load(train_files[<span class="dv">0</span>])</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>waves <span class="op">=</span> np.hstack(waves)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>waves <span class="op">=</span> waves <span class="op">/</span> np.<span class="bu">max</span>(waves)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>waves <span class="op">=</span> torch.from_numpy(waves).<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:23.638706Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:23.637241Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:23.716699Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:23.716076Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:24.981234Z&quot;}" data-papermill="{&quot;duration&quot;:1.012117,&quot;end_time&quot;:&quot;2021-10-01T09:46:23.716907&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:22.704790&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="27">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>qtfm()(waves)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 20.5 ms, sys: 957 ¬µs, total: 21.5 ms
Wall time: 26.3 ms</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>tensor([[[0.3868, 0.3814, 0.3670,  ..., 0.1262, 0.1258, 0.1258],
         [0.3012, 0.2917, 0.2653,  ..., 0.1504, 0.1565, 0.1585],
         [0.2445, 0.2453, 0.2446,  ..., 0.0945, 0.0961, 0.0965],
         ...,
         [0.0027, 0.0040, 0.0072,  ..., 0.0018, 0.0076, 0.0014],
         [0.0027, 0.0040, 0.0120,  ..., 0.0012, 0.0061, 0.0126],
         [0.0039, 0.0140, 0.0172,  ..., 0.0010, 0.0064, 0.0160]]])</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:25.601583Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:25.596457Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:30.895253Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:30.895860Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:25.077077Z&quot;}" data-papermill="{&quot;duration&quot;:6.241553,&quot;end_time&quot;:&quot;2021-10-01T09:46:30.896058&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:24.654505&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="28">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    waves <span class="op">=</span> np.load(df.iloc[i].<span class="bu">id</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    waves <span class="op">=</span> np.hstack(waves)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    waves <span class="op">=</span> waves <span class="op">/</span> np.<span class="bu">max</span>(waves)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    waves <span class="op">=</span> torch.from_numpy(waves).<span class="bu">float</span>()</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> qtfm()(waves)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    target <span class="op">=</span> get_label(train_files[i])</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    plt.imshow(image[<span class="dv">0</span>])</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"target: </span><span class="sc">{</span>target<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-29-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-29-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-29-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-29-output-4.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-29-output-5.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 5.37 s, sys: 391 ms, total: 5.77 s
Wall time: 5.23 s</code></pre>
</div>
</div>
<p>Cool! so we are able to plot the images now. IT is fast too.</p>
</section>
<section id="creating-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="creating-the-dataset">Creating the datasetüñ´</h2>
<p>If you want to use fastai‚Äôs learner to train your model on the transfomed spectograms, you can do so by creating a custom Dataset in pytorch and then feeding that dataset with a dataloader to fastai‚Äôs learner. However, if you create a pipeline using fastai‚Äôs internals then you get to use some cool functionalities out-of-box. We will see that in a while.</p>
<p>All the code below are very heavily insipired by the original inspiration of this notebook (see the very first section), this <a href="https://ohmeow.com/posts/2020/04/11/finding-datablock-nirvana-part-1.html">post</a> by Wayde Gilliam and the fastai s<a href="https://docs.fast.ai/tutorial.siamese.html#Writing-your-custom-data-block">iamese tutorial</a>.</p>
</section>
<section id="spectogram" class="level2">
<h2 class="anchored" data-anchor-id="spectogram">Spectogram</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:38.635390Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:38.634529Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:38.672205Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:38.671761Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:30.406874Z&quot;}" data-papermill="{&quot;duration&quot;:1.040374,&quot;end_time&quot;:&quot;2021-10-01T09:46:38.672322&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:37.631948&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="29">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_waves(f):</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""read numpy file, stack the timeseries and convert those into a tensor"""</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    waves <span class="op">=</span> np.load(f)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    waves <span class="op">=</span> np.hstack(waves)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    waves <span class="op">=</span> waves <span class="op">/</span> np.<span class="bu">max</span>(waves)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    waves <span class="op">=</span> torch.from_numpy(waves).<span class="bu">float</span>()</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> waves</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_spectrogram(x: Path):</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create an AudioSpectrogram from a torch tensor"""</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    waves <span class="op">=</span> get_waves(x)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> qtfm()(waves)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="nnaudioimagefastuple" class="level2">
<h2 class="anchored" data-anchor-id="nnaudioimagefastuple">NNAudioImage(fastuple)</h2>
<p>First of all, we are going to create an ‚ÄúImage type‚Äù for our transformed object (it‚Äôs the numpy data transformed into spectrogram).</p>
<p>We have to do this because our data is not an image data from get-go. Rather it‚Äôs a signal data which we are transforming into an Image. So, to tell fastai that this is a custom Image type which we are dealing with and ho we should be displaying it, we have to create an Image type.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:42.640974Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:42.640100Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:42.682156Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:42.682564Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:30.452342Z&quot;}" data-papermill="{&quot;duration&quot;:0.976227,&quot;end_time&quot;:&quot;2021-10-01T09:46:42.682724&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:41.706497&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="30">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AudioImage(fastuple):</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Custom Image for nnAudio transformed signals"""</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> show(<span class="va">self</span>, figsize<span class="op">=</span><span class="va">None</span>, ctx<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(<span class="va">self</span>) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>            img,label <span class="op">=</span> <span class="va">self</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> <span class="va">self</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="st">''</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> figsize <span class="kw">is</span> <span class="va">None</span>: figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> show_image(img, </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>                          title<span class="op">=</span>label, figsize<span class="op">=</span>figsize, ctx<span class="op">=</span>ctx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:44.745564Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:44.744856Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:44.806208Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:44.806594Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:30.498223Z&quot;}" data-papermill="{&quot;duration&quot;:1.171959,&quot;end_time&quot;:&quot;2021-10-01T09:46:44.806779&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:43.634820&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="31">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> create_spectrogram(train_files[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:47.017284Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:47.016481Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:47.057037Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:47.057452Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:30.555723Z&quot;}" data-papermill="{&quot;duration&quot;:0.986475,&quot;end_time&quot;:&quot;2021-10-01T09:46:47.057591&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:46.071116&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="32">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(image), image.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>(torch.Tensor, torch.Size([1, 46, 385]))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:48.987180Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:48.986310Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:49.029908Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:49.030272Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:30.599104Z&quot;}" data-papermill="{&quot;duration&quot;:1.022134,&quot;end_time&quot;:&quot;2021-10-01T09:46:49.030426&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:48.008292&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="33">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>image</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>tensor([[[0.3868, 0.3814, 0.3670,  ..., 0.1262, 0.1258, 0.1258],
         [0.3012, 0.2917, 0.2653,  ..., 0.1504, 0.1565, 0.1585],
         [0.2445, 0.2453, 0.2446,  ..., 0.0945, 0.0961, 0.0965],
         ...,
         [0.0027, 0.0040, 0.0072,  ..., 0.0018, 0.0076, 0.0014],
         [0.0027, 0.0040, 0.0120,  ..., 0.0012, 0.0061, 0.0126],
         [0.0039, 0.0140, 0.0172,  ..., 0.0010, 0.0064, 0.0160]]])</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:50.926387Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:50.924709Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:52.005861Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:52.005428Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:30.643874Z&quot;}" data-papermill="{&quot;duration&quot;:2.041741,&quot;end_time&quot;:&quot;2021-10-01T09:46:52.006020&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:49.964279&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="34">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>get_label(train_files[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>1</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:53.912432Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:53.911561Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:54.860807Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:54.862093Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:31.542498Z&quot;}" data-papermill="{&quot;duration&quot;:1.915439,&quot;end_time&quot;:&quot;2021-10-01T09:46:54.862354&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:52.946915&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="35">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> AudioImage(image, get_label(train_files[<span class="dv">0</span>]))</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>s.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>&lt;AxesSubplot:title={'center':'1'}&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-36-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="nnaudiodataset" class="level2">
<h2 class="anchored" data-anchor-id="nnaudiodataset">NNAudioDataset</h2>
<p>You can create a Dataset in fastai by creating a custom Transform . Creating a <code>Transform</code> has come advantages as compared to a pytorch Dataset. For example, you don‚Äôt need to have a <code>len</code> component or a <code>get_item</code> component.</p>
<p>On a very high level a <code>Transform</code> has an <code>encodes</code>, <code>decodes</code> and <code>setup</code> methods. For our purpose having an <code>encodes</code> methods only would suffice. This is the place where we would be transforming the numpy data into spectograms.</p>
<p>To know more about <code>Tranforms</code> refer these ‚Äì&gt; * <a href="https://ohmeow.com/posts/2020/04/11/finding-datablock-nirvana-part-1.html">data block nirvana</a> * <a href="https://docs.fast.ai/tutorial.siamese.html#Writing-your-custom-data-block">Siamese tutorial</a> * <a href="https://github.com/fastai/fastbook/blob/master/11_midlevel_data.ipynb">Fastbook chapter-11</a> * <a href="https://docs.fast.ai/tutorial.albumentations.html">Albumentation tutorial</a></p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:46:58.692060Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:46:58.691044Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:46:58.741958Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:46:58.742403Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:32.539202Z&quot;}" data-papermill="{&quot;duration&quot;:0.997913,&quot;end_time&quot;:&quot;2021-10-01T09:46:58.742549&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:57.744636&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="36">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>vals <span class="op">=</span> df.target.to_list()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 9.73 ms, sys: 0 ns, total: 9.73 ms
Wall time: 9.74 ms</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:00.797005Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:00.795629Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:00.854097Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:00.854636Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:32.614154Z&quot;}" data-papermill="{&quot;duration&quot;:1.023585,&quot;end_time&quot;:&quot;2021-10-01T09:47:00.854837&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:46:59.831252&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="37">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>vocab,o2i <span class="op">=</span> uniqueify(vals, sort<span class="op">=</span><span class="va">True</span>, bidir<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 12.7 ms, sys: 0 ns, total: 12.7 ms
Wall time: 12.8 ms</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:02.943981Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:02.943083Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:03.830530Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:03.829980Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:32.671726Z&quot;}" data-papermill="{&quot;duration&quot;:2.044575,&quot;end_time&quot;:&quot;2021-10-01T09:47:03.830671&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:01.786096&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="38">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>lbl2path <span class="op">=</span> mapxy(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:05.897567Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:05.895956Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:05.946935Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:05.947312Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:33.587967Z&quot;}" data-papermill="{&quot;duration&quot;:1.035406,&quot;end_time&quot;:&quot;2021-10-01T09:47:05.947473&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:04.912067&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="39">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>lbl2path[train_files[<span class="dv">5</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 13 ¬µs, sys: 5 ¬µs, total: 18 ¬µs
Wall time: 21.5 ¬µs</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>1</code></pre>
</div>
</div>
<p>combining all above steps</p>
</section>
<section id="nnaudiotransformitemtransform" class="level2">
<h2 class="anchored" data-anchor-id="nnaudiotransformitemtransform">NNAudioTransform(ItemTransform)</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:11.625588Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:11.624772Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:11.665630Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:11.665229Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:33.636217Z&quot;}" data-papermill="{&quot;duration&quot;:1.027127,&quot;end_time&quot;:&quot;2021-10-01T09:47:11.665767&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:10.638640&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="40">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co">#ItemTransform let's you work with tuple elements</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NNAudioTransform(ItemTransform):</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Custom Transform which uses nnAudio transforms</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co">    to extract spectogram on the fly"""</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, df: DataFrame, col: <span class="bu">str</span> <span class="op">=</span> <span class="st">'target'</span>):</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lbl2files <span class="op">=</span> mapxy(df)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> df[col].to_list()</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vocab,<span class="va">self</span>.o2i <span class="op">=</span> uniqueify(vals, sort<span class="op">=</span><span class="va">True</span>, bidir<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> encodes(<span class="va">self</span>, o): <span class="cf">return</span> (create_spectrogram(o), <span class="va">self</span>.o2i.get(<span class="va">self</span>.lbl2files.get(o)))</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> decodes(<span class="va">self</span>, x): <span class="cf">return</span> AudioImage(x[<span class="dv">0</span>],<span class="va">self</span>.vocab[x[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let‚Äôs walk through the code.</p>
<p>If you inherit from the <code>Transform</code> class, the resulting transform is applied to the item as a whole but when you inherit from the <code>ItemTransform</code> class then the resulting transform is applied to each element of the input.</p>
<p>For example, if you have a transform that is inherited from the <code>Transform</code> class and you have an input which is a tuple <code>("a", 1)</code> then the transform would consider the tuple as a single element. But, when your transform is an <code>ItemTransform</code> then the transform is applied to ‚Äúa‚Äù as well as ‚Äú1‚Äù separately.</p>
<p>The <strong>init</strong> method sets up our <code>mapxy</code> method as a class property. It then converts the target column values into a list and creates a vocab of our targets and a dictionary mapping our targets to indices.</p>
<p>The encodes method is where the magic occurs. Here, we return a tuple with our spectogram and the label related to our input.</p>
<p>The decodes method returns an <code>AudioImage</code> type which knows how to show itself whenever a <code>show</code> method is invoked.</p>
<p>You might notice that I have used a dataframe to create a list of our inputs and a dictionary of our labels. This was an engineering choice which I made because creating a list of labels from the input list of filenames was too slow. Doing it this was by using a dataframe made things faster.</p>
<blockquote class="blockquote">
<p>In deep learning a majority chunk of the speed boost comes from good engineering practices rather than having the best SOTA architectures or a faster computer.</p>
</blockquote>
<p>We will also use a ‚Äòsplitter‚Äô which tells fastai the way we want to split our data. For now we will use <code>RandomSplitter</code> to do this job. Additionally we will also instantiate the <code>NNAudioTransform</code> object.</p>
<p>We will take a few samples only to make our experiment quicker.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:20.017965Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:20.017058Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:20.054366Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:20.053935Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:33.681518Z&quot;}" data-papermill="{&quot;duration&quot;:1.013842,&quot;end_time&quot;:&quot;2021-10-01T09:47:20.054489&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:19.040647&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="41">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>subset_for_dsets <span class="op">=</span> train_files[:<span class="dv">20000</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:21.970543Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:21.969564Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:22.882746Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:22.882201Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:33.723325Z&quot;}" data-papermill="{&quot;duration&quot;:1.893631,&quot;end_time&quot;:&quot;2021-10-01T09:47:22.882884&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:20.989253&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="42">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> TrainTestSplitter()(subset_for_dsets)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> NNAudioTransform(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>tfm</code> is a transform is would be applied to the input files to generate the spectogram. The second list has the transform which will be applied to our targets.</p>
<p>Next, we have to tell fastai to take our ‚Äòsample‚Äô and apply the transform and the splitter to it.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:28.804138Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:28.803292Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:28.945593Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:28.946246Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:34.952326Z&quot;}" data-papermill="{&quot;duration&quot;:1.10064,&quot;end_time&quot;:&quot;2021-10-01T09:47:28.946573&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:27.845933&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="43">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>tls <span class="op">=</span> TfmdLists(subset_for_dsets, tfm, splits<span class="op">=</span>splits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 85 ms, sys: 278 ¬µs, total: 85.3 ms
Wall time: 105 ms</code></pre>
</div>
</div>
<p><code>TfmdLists</code> is a low-level API which creates a pipeline for us. It creates a pipeline that takes in our samples‚Äì&gt;splits it ‚Äì&gt; applies our transform to the items.</p>
<p>More information on a <code>TfmdLists</code> can be found in this <a href="https://docs.fast.ai/tutorial.pets.html">tutorial</a> fromt he official documentation.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:32.725627Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:32.724819Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:32.770143Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:32.769672Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:35.047280Z&quot;}" data-papermill="{&quot;duration&quot;:0.98551,&quot;end_time&quot;:&quot;2021-10-01T09:47:32.770266&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:31.784756&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="44">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>tls.vocab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>[0, 1]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:34.697652Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:34.696749Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:34.947680Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:34.948227Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:35.092640Z&quot;}" data-papermill="{&quot;duration&quot;:1.204399,&quot;end_time&quot;:&quot;2021-10-01T09:47:34.948399&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:33.744000&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="45">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>show_at(tls.train, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>&lt;AxesSubplot:title={'center':'0'}&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-46-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="create-the-dataloader" class="level2">
<h2 class="anchored" data-anchor-id="create-the-dataloader">Create the Dataloaderüñ®Ô∏è</h2>
<p>We can use the <code>TfmdLists</code> to create a dataloader by calling <code>dataloaders()</code>. Here, we can‚Äôt apply <code>item_tfms</code> or <code>batch_tfms</code> but we can get the hooks to different point of the pipeline and can put our transforms there.</p>
<p>For example, once items are grabbed then that moment is known as ‚Äúafter_item‚Äù. We can use this hook to apply our transforms once items are grabbed.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:38.998868Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:38.997927Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:42.176502Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:42.175977Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:35.377106Z&quot;}" data-papermill="{&quot;duration&quot;:4.169865,&quot;end_time&quot;:&quot;2021-10-01T09:47:42.176642&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:38.006777&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="46">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> tls.dataloaders(after_item<span class="op">=</span>[ToTensor()], after_batch<span class="op">=</span>[IntToFloatTensor(), Normalize.from_stats(<span class="op">*</span>imagenet_stats)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>One more thing that we need to do is to make the <code>show_batch</code> method aware of the type of our Image. This can be easily done by using <code>typedispatch</code> to dispatch our <code>show_batch</code> (the one which we will override with our image type).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:45.996932Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:45.996106Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:46.038582Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:46.038974Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:38.708753Z&quot;}" data-papermill="{&quot;duration&quot;:0.994521,&quot;end_time&quot;:&quot;2021-10-01T09:47:46.039118&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:45.044597&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="47">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="at">@typedispatch</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_batch(x:AudioImage, y, samples, ctxs<span class="op">=</span><span class="va">None</span>, max_n<span class="op">=</span><span class="dv">6</span>, nrows<span class="op">=</span><span class="va">None</span>, ncols<span class="op">=</span><span class="dv">3</span>, figsize<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> figsize <span class="kw">is</span> <span class="va">None</span>: figsize <span class="op">=</span> (ncols<span class="op">*</span><span class="dv">6</span>, max_n<span class="op">//</span>ncols <span class="op">*</span> <span class="dv">3</span>)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ctxs <span class="kw">is</span> <span class="va">None</span>: ctxs <span class="op">=</span> get_grid(<span class="bu">min</span>(x[<span class="dv">0</span>].shape[<span class="dv">0</span>], max_n), nrows<span class="op">=</span><span class="va">None</span>, ncols<span class="op">=</span>ncols, figsize<span class="op">=</span>figsize)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i,ctx <span class="kw">in</span> <span class="bu">enumerate</span>(ctxs):</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>        AudioImage(x[<span class="dv">0</span>][i], [<span class="st">'0'</span>,<span class="st">'1'</span>][x[<span class="dv">1</span>][i].item()]).show(ctx<span class="op">=</span>ctx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>typedispatch</code> does something similar to <a href="https://en.wikipedia.org/wiki/Multiple_dispatch">multi-dispatch</a>. So, that whenever we call the <code>show_batch</code> on our image type then fastai will call our version of <code>show_batch</code> after recognizing our image type.</p>
<p>Here we go</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:47:52.664378Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:47:52.663533Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:47:55.106725Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:47:55.105982Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:38.756317Z&quot;}" data-papermill="{&quot;duration&quot;:3.402168,&quot;end_time&quot;:&quot;2021-10-01T09:47:55.106907&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:47:51.704739&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="48">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1.05 s, sys: 15.8 ms, total: 1.07 s
Wall time: 1.62 s</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-49-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-49-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-49-output-4.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-49-output-5.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-49-output-6.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-49-output-7.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-49-output-8.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-49-output-9.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-49-output-10.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="modularity" class="level2">
<h2 class="anchored" data-anchor-id="modularity">Modularity üß©</h2>
<p>The way that we have created the above transform works well for a specific type of task. There are somethings which could not be answered by the above transform.</p>
<ul>
<li>What is the categories are other than 0 and 1.</li>
<li>What if it‚Äôs a multicategory problem.</li>
<li>How to handle the lack of targets during inference?
<ul>
<li>This could be handled by having a <code>setups</code> method inside the transform and have it accept list of filenames. This could work well when data is small but for huge data mapping the labelling function to all the filenames in order to create a vocab and label maps would take lots of time. In short it doesn‚Äôt scale well.</li>
</ul></li>
</ul>
<p>So what do we do?</p>
<p>The solution is to create a custom datablock for our type of task which can then be plugged into a <code>Datablock</code> like this‚Äì&gt;</p>
<pre><code>DataBlock(blocks=(NNAudioBlock, MultiCategoryBlock),
                   splitter=ColSplitter(),
                   get_x=lambda x:pascal_source/"train"/f'{x[0]}',
                   get_y=lambda x:x[1].split(' '),
                   item_tfms=Resize(224),
                   batch_tfms=aug_transforms())</code></pre>
<p>Let‚Äôs create a type to represent our spectrogram</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:01.123652Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:01.122736Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:01.168097Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:01.167552Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:41.095486Z&quot;}" data-papermill="{&quot;duration&quot;:1.00829,&quot;end_time&quot;:&quot;2021-10-01T09:48:01.168234&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:00.159944&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="49">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Spectrogram(TensorImageBase):</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Type to represent a spectogram which knows show itself"""</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create(cls, o):</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>        waves <span class="op">=</span> get_waves(o)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls(qtfm()(waves))</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> show(<span class="va">self</span>, figsize<span class="op">=</span><span class="va">None</span>, ctx<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs): </span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> <span class="va">self</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(t, Tensor): <span class="cf">return</span> ctx</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> figsize <span class="kw">is</span> <span class="va">None</span>: figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> show_image(t, figsize<span class="op">=</span>figsize, ctx<span class="op">=</span>ctx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the above class we use the functions <code>get_waves</code> and <code>qtfm()</code> defined in the previous sections to create a spectrogram. The <code>show</code> method is also similar to the <code>show</code> method which we had used in the previous section. The only difference is that in this show method we are not taking the label into account because the <code>Spectogram</code> is just a type of a file converted to a spectrogram.</p>
<p>but does it work? let‚Äôs test it.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:06.929053Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:06.928218Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:06.988978Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:06.989415Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:41.160097Z&quot;}" data-papermill="{&quot;duration&quot;:1.019016,&quot;end_time&quot;:&quot;2021-10-01T09:48:06.989594&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:05.970578&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="50">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>spectrogram <span class="op">=</span> Spectrogram.create(train_files[<span class="dv">0</span>])</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(spectrogram)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>__main__.Spectrogram</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:09.184491Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:09.183642Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:09.323334Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:09.323985Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:41.224793Z&quot;}" data-papermill="{&quot;duration&quot;:1.359101,&quot;end_time&quot;:&quot;2021-10-01T09:48:09.324218&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:07.965117&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="51">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>spectrogram.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>&lt;AxesSubplot:&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-52-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Voila! it knows how to show itself.</p>
<p>Now, we can create a custom block for our data. A block is a set of default transforms which is supposed to be applied to your data in order to tell fastai about the type of your data.</p>
<p>In our custom block we will tell fastai how create a Spectrogram block and then apply <code>IntToFloatTensor</code> transform.</p>
<p>The source code an <code>ImageBlock</code> is like this‚Äì&gt;</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:15.143909Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:15.142886Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:15.234698Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:15.234238Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:41.373505Z&quot;}" data-papermill="{&quot;duration&quot;:1.06192,&quot;end_time&quot;:&quot;2021-10-01T09:48:15.234828&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:14.172908&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="52">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>ImageBlock??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We will use the source code for <code>ImageBlock</code> to create our custom block.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:19.136082Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:19.134707Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:19.177527Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:19.177130Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:41.489147Z&quot;}" data-papermill="{&quot;duration&quot;:1.008731,&quot;end_time&quot;:&quot;2021-10-01T09:48:19.177644&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:18.168913&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="53">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> SpectrogramBlock(cls<span class="op">=</span>Spectrogram) : </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"A `TransformBlock` for spectograms of `cls`"</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> TransformBlock(type_tfms<span class="op">=</span>cls.create, batch_tfms<span class="op">=</span>IntToFloatTensor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now that we have our custom block ready, we can test if a DataBlock can now be created.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:23.254024Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:23.253090Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:23.297580Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:23.297170Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:41.530469Z&quot;}" data-papermill="{&quot;duration&quot;:1.027546,&quot;end_time&quot;:&quot;2021-10-01T09:48:23.297733&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:22.270187&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="54">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>g2net <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(SpectrogramBlock, CategoryBlock),</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>                   splitter<span class="op">=</span>RandomSplitter(),</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>                   get_x<span class="op">=</span>ColReader(<span class="dv">0</span>),</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>                   get_y<span class="op">=</span>ColReader(<span class="dv">1</span>),</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>                   batch_tfms<span class="op">=</span>aug_transforms())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, we create the dataloader.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:27.660541Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:27.659646Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:28.070300Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:28.069837Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:41.574332Z&quot;}" data-papermill="{&quot;duration&quot;:1.397119,&quot;end_time&quot;:&quot;2021-10-01T09:48:28.070439&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:26.673320&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="55">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> g2net.dataloaders(df.iloc[:<span class="dv">2000</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:29.990983Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:29.990074Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:32.467094Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:32.468308Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:41.884309Z&quot;}" data-papermill="{&quot;duration&quot;:3.443577,&quot;end_time&quot;:&quot;2021-10-01T09:48:32.468547&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:29.024970&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="56">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1.19 s, sys: 5.58 ms, total: 1.2 s
Wall time: 1.7 s</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-57-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-57-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-57-output-4.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-57-output-5.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-57-output-6.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-57-output-7.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-57-output-8.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-57-output-9.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-57-output-10.png" class="img-fluid"></p>
</div>
</div>
<p>Here we go. Now we have a custom block and we can create a DataBlock as well as dataloaders and then display it.</p>
</section>
<section id="make-your-own-model" class="level2">
<h2 class="anchored" data-anchor-id="make-your-own-model">Make your own modelüçï</h2>
<p>We are going to use the timm library as the source of our model. To weave it into fastai, we will create a custom fastai model.</p>
<p>All the code below is heavily inspired by‚Äì&gt;</p>
<ul>
<li><a href="https://www.kaggle.com/benihime91">Ayushman‚Äôs</a> <a href="https://www.kaggle.com/benihime91/fastai-timm-efficientnet-train-fold-0">notebook</a>.</li>
<li>fastai siamese <a href="https://docs.fast.ai/tutorial.siamese.html">tutorial</a>.</li>
</ul>
<p>We will also take into account the structure of fastai‚Äôs <code>create_cnn_model</code> class. The code for which is as follows</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:38.298017Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:38.297087Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:38.348364Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:38.349249Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:44.287464Z&quot;}" data-papermill="{&quot;duration&quot;:1.023296,&quot;end_time&quot;:&quot;2021-10-01T09:48:38.349404&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:37.326108&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="57">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>create_cnn_model??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let‚Äôs build our own.</p>
<p>We will cut off the head of a timm pretrained model using <code>create_body</code> and take the encoder only as this would be the portion of the pretrained model which I would like to use. Then I will top it off with a custom fastai head using <code>create_head</code> that we would need to train on our target data.</p>
<p>To know more about this flow have a look into the fastai siamese <a href="https://docs.fast.ai/tutorial.siamese.html">tutorial</a>.</p>
<p>But first we will create our custom <code>create_body</code> and <code>create_head</code> functions. the reason for this is that fastai in it‚Äôs current state is not integrated with the timm library. So, creating custom versions of <code>create_body</code> and <code>create_head</code> makes the weaving of timm into fastai re-usable.</p>
<p>The insipration for this is the <a href="https://walkwithfastai.com/vision.external.timm#create_timm_body">post</a> in ‚Äòwalk with fastai‚Äô. Once again the code and the approach is based on this post.</p>
<blockquote class="blockquote">
<p>I am recreating this again here instead of using the ‚Äòwalk with fastai‚Äô library is to drill down into the concept and for my personal learning.</p>
</blockquote>
</section>
<section id="create_timm_bodyarch-n_in3-pretrainedtrue-cutnone" class="level2">
<h2 class="anchored" data-anchor-id="create_timm_bodyarch-n_in3-pretrainedtrue-cutnone">create_timm_body(arch, n_in=3, pretrained=True, cut=None)</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:46.406982Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:46.406055Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:46.448766Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:46.448322Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:44.365319Z&quot;}" data-papermill="{&quot;duration&quot;:1.013044,&quot;end_time&quot;:&quot;2021-10-01T09:48:46.448901&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:45.435857&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="58">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_timm_body(arch, n_in<span class="op">=</span><span class="dv">3</span>, pretrained<span class="op">=</span><span class="va">True</span>, cut<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Cut off the body of a typically pretrained timm library `arch` as determined by `cut`"</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> create_model(arch, pretrained<span class="op">=</span>pretrained, num_classes<span class="op">=</span><span class="dv">0</span>, in_chans<span class="op">=</span><span class="dv">1</span>,global_pool<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    _update_first_layer(model, n_in, pretrained)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#cut = ifnone(cut, cnn_config(arch)['cut'])</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cut <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        ll <span class="op">=</span> <span class="bu">list</span>(<span class="bu">enumerate</span>(model.children()))</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        cut <span class="op">=</span> <span class="bu">next</span>(i <span class="cf">for</span> i,o <span class="kw">in</span> <span class="bu">reversed</span>(ll) <span class="cf">if</span> has_pool_type(o))</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>   <span class="bu">isinstance</span>(cut, <span class="bu">int</span>):      <span class="cf">return</span> nn.Sequential(<span class="op">*</span><span class="bu">list</span>(model.children())[:cut])</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">callable</span>(cut): <span class="cf">return</span> cut(model)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="cf">raise</span> NamedError(<span class="st">"cut must be either integer or a function"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now that we have a way to create a body, we will use the code from <code>create_cnn_model</code> to build our custom <code>create_timm_model</code>.</p>
<p>The code for <code>create_timm_model</code> is as follows.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:50.354373Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:50.353547Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:50.403582Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:50.403123Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:44.414966Z&quot;}" data-papermill="{&quot;duration&quot;:1.02624,&quot;end_time&quot;:&quot;2021-10-01T09:48:50.403714&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:49.377474&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="59">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>create_cnn_model??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="create_timm_model" class="level2">
<h2 class="anchored" data-anchor-id="create_timm_model">create_timm_model</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:54.502396Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:54.501529Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:54.543716Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:54.544160Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:44.474031Z&quot;}" data-papermill="{&quot;duration&quot;:1.018507,&quot;end_time&quot;:&quot;2021-10-01T09:48:54.544307&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:53.525800&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="60">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>create_head?</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:48:56.565422Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:48:56.561716Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:48:56.630040Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:48:56.628742Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:44.524051Z&quot;}" data-papermill="{&quot;duration&quot;:1.092977,&quot;end_time&quot;:&quot;2021-10-01T09:48:56.630211&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:48:55.537234&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="61">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(create_head)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_timm_model(arch, n_out, pretrained<span class="op">=</span><span class="va">True</span>, cut<span class="op">=</span><span class="va">None</span>, n_in<span class="op">=</span><span class="dv">3</span>, init<span class="op">=</span>nn.init.kaiming_normal_, custom_head<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>                     concat_pool<span class="op">=</span><span class="va">True</span>, in_chans<span class="op">=</span><span class="dv">1</span>, <span class="op">**</span>kwargs):</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create custom architecture from the timm library"</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    body <span class="op">=</span> create_timm_body(arch, n_in, pretrained, <span class="va">None</span>)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> custom_head <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>        nf <span class="op">=</span> num_features_model(nn.Sequential(<span class="op">*</span>body.children()))</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>        head <span class="op">=</span> create_head(nf, n_out, concat_pool<span class="op">=</span>concat_pool, <span class="op">**</span>kwargs)</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: head <span class="op">=</span> custom_head</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> nn.Sequential(body, head)</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> init <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: apply_init(model[<span class="dv">1</span>], init)</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>@delegate</code> macro tells fastai to show the parameters of any <code>**kwargs</code> (which we would be using in the <code>create_body</code>) during function <a href="https://fastcore.fast.ai/meta.html#delegates">introspection</a>.</p>
<p>Let‚Äôs do a quick test to check if our custom model works.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:49:03.005064Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:49:03.004115Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:49:03.042351Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:49:03.041931Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:44.573818Z&quot;}" data-papermill="{&quot;duration&quot;:1.012878,&quot;end_time&quot;:&quot;2021-10-01T09:49:03.042472&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:49:02.029594&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="62">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># num of classes</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>n_out <span class="op">=</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:49:05.214552Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:49:05.213601Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:49:07.475507Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:49:07.474958Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:44.617871Z&quot;}" data-papermill="{&quot;duration&quot;:3.231905,&quot;end_time&quot;:&quot;2021-10-01T09:49:07.475633&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:49:04.243728&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="63">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> create_timm_model(<span class="st">"efficientnet_b3a"</span>, n_out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://github.com/rwightman/pytorch-image-models/releases/download/v0.1-weights/efficientnet_b3_ra2-cf984f9c.pth" to /root/.cache/torch/hub/checkpoints/efficientnet_b3_ra2-cf984f9c.pth</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:49:09.437591Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:49:09.436794Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:49:09.481688Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:49:09.482159Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:46.372602Z&quot;}" data-papermill="{&quot;duration&quot;:1.026279,&quot;end_time&quot;:&quot;2021-10-01T09:49:09.482384&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:49:08.456105&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="64">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>L(model.children())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>(#2) [Sequential(
  (0): Conv2d(1, 40, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
  (1): BatchNorm2d(40, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (2): SiLU(inplace=True)
  (3): Sequential(
    (0): Sequential(
      (0): DepthwiseSeparableConv(
        (conv_dw): Conv2d(40, 40, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=40, bias=False)
        (bn1): BatchNorm2d(40, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(40, 10, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(10, 40, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pw): Conv2d(40, 24, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn2): BatchNorm2d(24, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): Identity()
      )
      (1): DepthwiseSeparableConv(
        (conv_dw): Conv2d(24, 24, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=24, bias=False)
        (bn1): BatchNorm2d(24, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(24, 6, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(6, 24, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pw): Conv2d(24, 24, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn2): BatchNorm2d(24, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): Identity()
      )
    )
    (1): Sequential(
      (0): InvertedResidual(
        (conv_pw): Conv2d(24, 144, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(144, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(144, 144, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), groups=144, bias=False)
        (bn2): BatchNorm2d(144, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(144, 6, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(6, 144, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(144, 32, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (1): InvertedResidual(
        (conv_pw): Conv2d(32, 192, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(192, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(192, 192, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=192, bias=False)
        (bn2): BatchNorm2d(192, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(192, 8, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(8, 192, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(192, 32, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (2): InvertedResidual(
        (conv_pw): Conv2d(32, 192, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(192, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(192, 192, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=192, bias=False)
        (bn2): BatchNorm2d(192, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(192, 8, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(8, 192, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(192, 32, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (2): Sequential(
      (0): InvertedResidual(
        (conv_pw): Conv2d(32, 192, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(192, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(192, 192, kernel_size=(5, 5), stride=(2, 2), padding=(2, 2), groups=192, bias=False)
        (bn2): BatchNorm2d(192, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(192, 8, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(8, 192, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(192, 48, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(48, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (1): InvertedResidual(
        (conv_pw): Conv2d(48, 288, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(288, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(288, 288, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=288, bias=False)
        (bn2): BatchNorm2d(288, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(288, 12, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(12, 288, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(288, 48, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(48, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (2): InvertedResidual(
        (conv_pw): Conv2d(48, 288, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(288, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(288, 288, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=288, bias=False)
        (bn2): BatchNorm2d(288, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(288, 12, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(12, 288, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(288, 48, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(48, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (3): Sequential(
      (0): InvertedResidual(
        (conv_pw): Conv2d(48, 288, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(288, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(288, 288, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), groups=288, bias=False)
        (bn2): BatchNorm2d(288, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(288, 12, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(12, 288, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(288, 96, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(96, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (1): InvertedResidual(
        (conv_pw): Conv2d(96, 576, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(576, 576, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=576, bias=False)
        (bn2): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(576, 24, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(24, 576, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(576, 96, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(96, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (2): InvertedResidual(
        (conv_pw): Conv2d(96, 576, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(576, 576, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=576, bias=False)
        (bn2): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(576, 24, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(24, 576, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(576, 96, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(96, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (3): InvertedResidual(
        (conv_pw): Conv2d(96, 576, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(576, 576, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=576, bias=False)
        (bn2): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(576, 24, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(24, 576, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(576, 96, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(96, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (4): InvertedResidual(
        (conv_pw): Conv2d(96, 576, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(576, 576, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=576, bias=False)
        (bn2): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(576, 24, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(24, 576, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(576, 96, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(96, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (4): Sequential(
      (0): InvertedResidual(
        (conv_pw): Conv2d(96, 576, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(576, 576, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=576, bias=False)
        (bn2): BatchNorm2d(576, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(576, 24, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(24, 576, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(576, 136, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(136, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (1): InvertedResidual(
        (conv_pw): Conv2d(136, 816, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(816, 816, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=816, bias=False)
        (bn2): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(816, 34, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(34, 816, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(816, 136, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(136, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (2): InvertedResidual(
        (conv_pw): Conv2d(136, 816, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(816, 816, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=816, bias=False)
        (bn2): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(816, 34, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(34, 816, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(816, 136, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(136, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (3): InvertedResidual(
        (conv_pw): Conv2d(136, 816, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(816, 816, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=816, bias=False)
        (bn2): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(816, 34, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(34, 816, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(816, 136, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(136, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (4): InvertedResidual(
        (conv_pw): Conv2d(136, 816, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(816, 816, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=816, bias=False)
        (bn2): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(816, 34, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(34, 816, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(816, 136, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(136, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (5): Sequential(
      (0): InvertedResidual(
        (conv_pw): Conv2d(136, 816, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(816, 816, kernel_size=(5, 5), stride=(2, 2), padding=(2, 2), groups=816, bias=False)
        (bn2): BatchNorm2d(816, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(816, 34, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(34, 816, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(816, 232, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(232, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (1): InvertedResidual(
        (conv_pw): Conv2d(232, 1392, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(1392, 1392, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=1392, bias=False)
        (bn2): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(1392, 58, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(58, 1392, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(1392, 232, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(232, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (2): InvertedResidual(
        (conv_pw): Conv2d(232, 1392, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(1392, 1392, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=1392, bias=False)
        (bn2): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(1392, 58, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(58, 1392, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(1392, 232, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(232, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (3): InvertedResidual(
        (conv_pw): Conv2d(232, 1392, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(1392, 1392, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=1392, bias=False)
        (bn2): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(1392, 58, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(58, 1392, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(1392, 232, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(232, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (4): InvertedResidual(
        (conv_pw): Conv2d(232, 1392, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(1392, 1392, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=1392, bias=False)
        (bn2): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(1392, 58, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(58, 1392, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(1392, 232, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(232, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (5): InvertedResidual(
        (conv_pw): Conv2d(232, 1392, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(1392, 1392, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2), groups=1392, bias=False)
        (bn2): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(1392, 58, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(58, 1392, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(1392, 232, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(232, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (6): Sequential(
      (0): InvertedResidual(
        (conv_pw): Conv2d(232, 1392, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(1392, 1392, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=1392, bias=False)
        (bn2): BatchNorm2d(1392, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(1392, 58, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(58, 1392, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(1392, 384, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(384, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (1): InvertedResidual(
        (conv_pw): Conv2d(384, 2304, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn1): BatchNorm2d(2304, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act1): SiLU(inplace=True)
        (conv_dw): Conv2d(2304, 2304, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=2304, bias=False)
        (bn2): BatchNorm2d(2304, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (act2): SiLU(inplace=True)
        (se): SqueezeExcite(
          (conv_reduce): Conv2d(2304, 96, kernel_size=(1, 1), stride=(1, 1))
          (act1): SiLU(inplace=True)
          (conv_expand): Conv2d(96, 2304, kernel_size=(1, 1), stride=(1, 1))
          (gate): Sigmoid()
        )
        (conv_pwl): Conv2d(2304, 384, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (bn3): BatchNorm2d(384, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
  )
  (4): Conv2d(384, 1536, kernel_size=(1, 1), stride=(1, 1), bias=False)
  (5): BatchNorm2d(1536, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (6): SiLU(inplace=True)
),Sequential(
  (0): AdaptiveConcatPool2d(
    (ap): AdaptiveAvgPool2d(output_size=1)
    (mp): AdaptiveMaxPool2d(output_size=1)
  )
  (1): Flatten(full=False)
  (2): BatchNorm1d(3072, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (3): Dropout(p=0.25, inplace=False)
  (4): Linear(in_features=3072, out_features=512, bias=False)
  (5): ReLU(inplace=True)
  (6): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (7): Dropout(p=0.5, inplace=False)
  (8): Linear(in_features=512, out_features=2, bias=False)
)]</code></pre>
</div>
</div>
<p>cool! so it works.</p>
<p>Now, we will build a learner which would enable us to do transfer learning with timm models. Once again we will port <code>cnn_learner</code> for our use and like before let‚Äôs quickly take a look into the <code>cnn_learner</code> code</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:49:13.475720Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:49:13.474788Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:49:13.531717Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:49:13.532394Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:46.420119Z&quot;}" data-papermill="{&quot;duration&quot;:1.033343,&quot;end_time&quot;:&quot;2021-10-01T09:49:13.532551&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:49:12.499208&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="65">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>cnn_learner??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:49:15.746011Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:49:15.745073Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:49:15.791554Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:49:15.791089Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:46.483258Z&quot;}" data-papermill="{&quot;duration&quot;:1.159368,&quot;end_time&quot;:&quot;2021-10-01T09:49:15.791688&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:49:14.632320&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="66">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(create_timm_model)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> timm_learner(dls, arch, n_out<span class="op">=</span><span class="va">None</span>, pretrained<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>                <span class="co"># learner args</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>                loss_func<span class="op">=</span><span class="va">None</span>, opt_func<span class="op">=</span>Adam, lr<span class="op">=</span>defaults.lr, splitter<span class="op">=</span><span class="va">None</span>, cbs<span class="op">=</span><span class="va">None</span>, metrics<span class="op">=</span><span class="va">None</span>, path<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>                model_dir<span class="op">=</span><span class="st">'models'</span>, wd<span class="op">=</span><span class="va">None</span>, wd_bn_bias<span class="op">=</span><span class="va">False</span>, train_bn<span class="op">=</span><span class="va">True</span>, moms<span class="op">=</span>(<span class="fl">0.95</span>,<span class="fl">0.85</span>,<span class="fl">0.95</span>),</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>                <span class="co"># other model args</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">**</span>kwargs):</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Build a convnet style learner from `dls` and `timm arch`"</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    kwargs <span class="op">=</span> {<span class="op">**</span>kwargs}</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_out <span class="kw">is</span> <span class="va">None</span>: n_out <span class="op">=</span> get_c(dls)</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> n_out, <span class="st">"`n_out` is not defined, and could not be inferred from data, set `dls.c` or pass `n_out`"</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> create_timm_model(arch, n_out, default_split, pretrained, <span class="op">**</span>kwargs)</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    learn <span class="op">=</span> Learner(dls<span class="op">=</span>dls, model<span class="op">=</span>model, loss_func<span class="op">=</span>loss_func, opt_func<span class="op">=</span>opt_func, lr<span class="op">=</span>lr, splitter<span class="op">=</span>default_split, cbs<span class="op">=</span>cbs,</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>                   metrics<span class="op">=</span>metrics, path<span class="op">=</span>path, model_dir<span class="op">=</span>model_dir, wd<span class="op">=</span>wd, wd_bn_bias<span class="op">=</span>wd_bn_bias, train_bn<span class="op">=</span>train_bn,</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>                   moms<span class="op">=</span>moms)</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pretrained: learn.freeze()</span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep track of args for loggers</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>    store_attr(<span class="st">'arch,n_out,pretrained'</span>, <span class="va">self</span><span class="op">=</span>learn, <span class="op">**</span>kwargs)</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> learn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here we go. We have managed to get a port of the learner code which looks the part. Does it work?</p>
<p>Let me find out.</p>
<blockquote class="blockquote">
<p>To find the list of models available in the timm library use <code>list_models</code></p>
</blockquote>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:49:19.842787Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:49:19.841843Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:49:19.887208Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:49:19.887628Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:06:46.526726Z&quot;}" data-papermill="{&quot;duration&quot;:1.078385,&quot;end_time&quot;:&quot;2021-10-01T09:49:19.887810&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:49:18.809425&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="67">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>list_models(<span class="st">"efficient*"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>['efficientnet_b0',
 'efficientnet_b1',
 'efficientnet_b1_pruned',
 'efficientnet_b2',
 'efficientnet_b2_pruned',
 'efficientnet_b2a',
 'efficientnet_b3',
 'efficientnet_b3_pruned',
 'efficientnet_b3a',
 'efficientnet_b4',
 'efficientnet_b5',
 'efficientnet_b6',
 'efficientnet_b7',
 'efficientnet_b8',
 'efficientnet_cc_b0_4e',
 'efficientnet_cc_b0_8e',
 'efficientnet_cc_b1_8e',
 'efficientnet_el',
 'efficientnet_el_pruned',
 'efficientnet_em',
 'efficientnet_es',
 'efficientnet_es_pruned',
 'efficientnet_l2',
 'efficientnet_lite0',
 'efficientnet_lite1',
 'efficientnet_lite2',
 'efficientnet_lite3',
 'efficientnet_lite4',
 'efficientnetv2_l',
 'efficientnetv2_m',
 'efficientnetv2_rw_m',
 'efficientnetv2_rw_s',
 'efficientnetv2_s']</code></pre>
</div>
</div>
</section>
<section id="the-learner" class="level2">
<h2 class="anchored" data-anchor-id="the-learner">The learnerüë©‚Äçüè´</h2>
<p>Now that we have the model in place, we can go ahead and create the learner the usual way. We have kept the batch size to default.</p>
<p>There is one little thing that I would like to do before creating a learner. I will create a helper function which can help me to get the suggested learning rate quickly.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:49:23.820183Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:49:23.818710Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:49:23.865467Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:49:23.866151Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:13:42.734505Z&quot;}" data-papermill="{&quot;duration&quot;:1.024225,&quot;end_time&quot;:&quot;2021-10-01T09:49:23.866315&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:49:22.842090&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="68">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_me_lrs(learn, num_it:<span class="bu">int</span><span class="op">=</span> <span class="dv">10</span>):</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    Suggested_lrs <span class="op">=</span> namedtuple(<span class="st">'Suggested_lrs'</span>, [<span class="st">"min"</span>, <span class="st">"steep"</span>,</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"valley"</span>, <span class="st">"slide"</span>])</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    lrs <span class="op">=</span> learn.lr_find(suggest_funcs<span class="op">=</span>(minimum, steep,valley, slide))</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    suggested_lrs <span class="op">=</span> Suggested_lrs(lrs[<span class="dv">0</span>], lrs[<span class="dv">1</span>], lrs[<span class="dv">2</span>], lrs[<span class="dv">3</span>])</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Minimum/10:</span><span class="ch">\t</span><span class="sc">{</span>lrs[<span class="dv">0</span>]<span class="sc">:.2e}</span><span class="ch">\</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a><span class="ss">          </span><span class="ch">\n</span><span class="ss">Steepest point:</span><span class="ch">\t</span><span class="sc">{</span>lrs[<span class="dv">1</span>]<span class="sc">:.2e}</span><span class="ch">\</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a><span class="ss">          </span><span class="ch">\n</span><span class="ss">Longest valley:</span><span class="ch">\t</span><span class="sc">{</span>lrs[<span class="dv">2</span>]<span class="sc">:.2e}</span><span class="ch">\</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a><span class="ss">          </span><span class="ch">\n</span><span class="ss">Slide interval:</span><span class="ch">\t</span><span class="sc">{</span>lrs[<span class="dv">3</span>]<span class="sc">:.2e}</span><span class="ss">"</span>)</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> suggested_lrs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:49:26.041900Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:49:26.041030Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:49:27.325462Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:49:27.324889Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:29:42.716691Z&quot;}" data-papermill="{&quot;duration&quot;:2.493525,&quot;end_time&quot;:&quot;2021-10-01T09:49:27.325598&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:49:24.832073&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="69">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> timm_learner(dls, <span class="st">'efficientnet_b7'</span>, loss_func<span class="op">=</span>CrossEntropyLossFlat(), metrics<span class="op">=</span>[RocAucBinary(axis<span class="op">=</span><span class="dv">0</span>)], n_out<span class="op">=</span><span class="dv">2</span>).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Fit one epoch to see how it behaves</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:49:31.910302Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:49:31.909522Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:50:09.834473Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:50:09.834898Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:29:45.448439Z&quot;}" data-papermill="{&quot;duration&quot;:39.042964,&quot;end_time&quot;:&quot;2021-10-01T09:50:09.835073&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:49:30.792109&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="70">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">1</span>, <span class="fl">3e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>roc_auc_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.216163</td>
      <td>0.700841</td>
      <td>0.482039</td>
      <td>00:37</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:50:11.774071Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:50:11.773279Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:50:12.888447Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:50:12.888894Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:30:40.513725Z&quot;}" data-papermill="{&quot;duration&quot;:2.088702,&quot;end_time&quot;:&quot;2021-10-01T09:50:12.889045&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:50:10.800343&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="71">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co">#to recover gpu ram</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>learn.save(<span class="st">'epoch1'</span>)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>learn.load(<span class="st">'epoch1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>&lt;fastai.learner.Learner at 0x7fdc87c14890&gt;</code></pre>
</div>
</div>
<p>Using the learning rate finder to get the learning rate</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:50:16.930497Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:50:16.929101Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:50:17.421231Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:50:17.421651Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:30:42.109656Z&quot;}" data-papermill="{&quot;duration&quot;:1.485204,&quot;end_time&quot;:&quot;2021-10-01T09:50:17.421821&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:50:15.936617&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="72">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc<span class="op">;</span> gc.collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>66411</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:50:19.366001Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:50:19.365185Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:52:04.055735Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:52:04.056146Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:30:44.227019Z&quot;}" data-papermill="{&quot;duration&quot;:105.679627,&quot;end_time&quot;:&quot;2021-10-01T09:52:04.056307&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:50:18.376680&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="73">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>suggested_lrs <span class="op">=</span> show_me_lrs(learn)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="co">#learn.lr_find(suggest_funcs=(minimum, steep,valley, slide))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/fastai/callback/schedule.py:269: UserWarning: color is redundantly defined by the 'color' keyword argument and the fmt string "ro" (-&gt; color='r'). The keyword argument will take precedence.
  ax.plot(val, idx, 'ro', label=nm, c=color)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Minimum/10: 1.00e-06          
Steepest point: 1.10e-06          
Longest valley: 6.92e-06          
Slide interval: 4.37e-03</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-74-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>I will use the slide algorithm here to get the optimal learning rate.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:52:07.942511Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:52:07.941631Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:53:58.985818Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:53:58.986212Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:32:50.302349Z&quot;}" data-papermill="{&quot;duration&quot;:112.01864,&quot;end_time&quot;:&quot;2021-10-01T09:53:58.986378&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:52:06.967738&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="74">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>learn.unfreeze()</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">3</span>, suggested_lrs.slide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>roc_auc_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.114650</td>
      <td>1.825437</td>
      <td>0.465078</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1.011949</td>
      <td>0.750606</td>
      <td>0.491870</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.917761</td>
      <td>0.708508</td>
      <td>0.516685</td>
      <td>00:37</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)
/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)</code></pre>
</div>
</div>
<p>Ok! The performance is not that great but the goal of this exercise was not to have a SOTA model but rather to learn how to create a custom code base by using Fastai internals.</p>
<p>However, with proper data augmentation and more data the performance can be much better.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:54:03.169154Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:54:03.168294Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:54:03.799126Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:54:03.798615Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:36:18.064035Z&quot;}" data-papermill="{&quot;duration&quot;:1.635374,&quot;end_time&quot;:&quot;2021-10-01T09:54:03.799254&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:54:02.163880&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="75">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>learn.export(<span class="st">"./final"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inferenceüßê</h2>
<p>For inference you will need to use the previous dataloader to create a test dataloader by passing the test files to it.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:54:07.873786Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:54:07.872798Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:55:14.281967Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:55:14.282586Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:36:21.814635Z&quot;}" data-papermill="{&quot;duration&quot;:67.415251,&quot;end_time&quot;:&quot;2021-10-01T09:55:14.282791&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:54:06.867540&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="76">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>test_path <span class="op">=</span> path<span class="op">/</span><span class="st">'g2net-gravitational-wave-detection/test'</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>test_files <span class="op">=</span> getfiles(test_path, <span class="st">"npy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.65 s, sys: 1.22 s, total: 3.86 s
Wall time: 1min 5s</code></pre>
</div>
</div>
</section>
<section id="inference-1" class="level2">
<h2 class="anchored" data-anchor-id="inference-1">Inference</h2>
<p>For inference we first load the learner</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:55:20.476564Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:55:20.475569Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:55:20.807110Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:55:20.806553Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:37:05.914115Z&quot;}" data-papermill="{&quot;duration&quot;:1.339238,&quot;end_time&quot;:&quot;2021-10-01T09:55:20.807243&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:55:19.468005&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="77">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> load_learner(<span class="st">'./final'</span>, cpu<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Create a test dataloader. This will take in the test files and apply the transforms that we had created during trainign timebut on the inference data and give you a dataloader.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:55:24.710407Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:55:24.708948Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:55:24.753638Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:55:24.753230Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:37:24.696766Z&quot;}" data-papermill="{&quot;duration&quot;:1.043913,&quot;end_time&quot;:&quot;2021-10-01T09:55:24.753777&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:55:23.709864&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="78">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>test_dls <span class="op">=</span> learn.dls.test_dl(test_files[:<span class="dv">100</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>check the batch</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:55:28.886711Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:55:28.885779Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:55:31.805234Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:55:31.805920Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:37:28.939545Z&quot;}" data-papermill="{&quot;duration&quot;:4.125493,&quot;end_time&quot;:&quot;2021-10-01T09:55:31.806190&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:55:27.680697&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="79">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>test_dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.7/site-packages/nnAudio/utils.py:326: SyntaxWarning: If fmax is given, n_bins will be ignored
  warnings.warn('If fmax is given, n_bins will be ignored',SyntaxWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-80-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-80-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-80-output-4.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-80-output-5.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-80-output-6.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-80-output-7.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-80-output-8.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-80-output-9.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Extending-Fastai-For-Custom-Task_files/figure-html/cell-80-output-10.png" class="img-fluid"></p>
</div>
</div>
<p>Use <code>get_preds</code> to get predictions in batches.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:55:35.809331Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:55:35.808474Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:55:39.479409Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:55:39.480339Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:37:35.135658Z&quot;}" data-papermill="{&quot;duration&quot;:4.669632,&quot;end_time&quot;:&quot;2021-10-01T09:55:39.480575&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:55:34.810943&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="80">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>test_dls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

</div>
</div>
<p>Have a look at your predictions.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2021-10-01T09:55:43.678763Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-10-01T09:55:43.677940Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-10-01T09:55:43.724131Z&quot;,&quot;shell.execute_reply&quot;:&quot;2021-10-01T09:55:43.723314Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-10-01T09:37:44.269234Z&quot;}" data-papermill="{&quot;duration&quot;:1.037782,&quot;end_time&quot;:&quot;2021-10-01T09:55:43.724262&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2021-10-01T09:55:42.686480&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="81">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>(tensor([[0.5247, 0.4753],
         [0.5247, 0.4753],
         [0.5248, 0.4752],
         [0.5247, 0.4753],
         [0.5252, 0.4748],
         [0.5249, 0.4751],
         [0.4635, 0.5365],
         [0.5260, 0.4740],
         [0.5246, 0.4754],
         [0.5247, 0.4753],
         [0.4650, 0.5350],
         [0.5247, 0.4753],
         [0.5270, 0.4730],
         [0.5247, 0.4753],
         [0.5247, 0.4753],
         [0.4974, 0.5026],
         [0.5246, 0.4754],
         [0.5246, 0.4754],
         [0.5247, 0.4753],
         [0.4956, 0.5044],
         [0.4867, 0.5133],
         [0.4694, 0.5306],
         [0.5264, 0.4736],
         [0.5246, 0.4754],
         [0.5247, 0.4753],
         [0.5247, 0.4753],
         [0.4893, 0.5107],
         [0.4874, 0.5126],
         [0.4887, 0.5113],
         [0.5246, 0.4754],
         [0.5247, 0.4753],
         [0.5246, 0.4754],
         [0.5248, 0.4752],
         [0.5247, 0.4753],
         [0.4840, 0.5160],
         [0.5248, 0.4752],
         [0.5247, 0.4753],
         [0.4933, 0.5067],
         [0.5247, 0.4753],
         [0.5247, 0.4753],
         [0.4694, 0.5306],
         [0.4978, 0.5022],
         [0.4897, 0.5103],
         [0.5247, 0.4753],
         [0.4885, 0.5115],
         [0.4894, 0.5106],
         [0.5246, 0.4754],
         [0.5247, 0.4753],
         [0.4868, 0.5132],
         [0.5247, 0.4753],
         [0.4903, 0.5097],
         [0.5247, 0.4753],
         [0.5247, 0.4753],
         [0.4875, 0.5125],
         [0.5250, 0.4750],
         [0.4724, 0.5276],
         [0.4901, 0.5099],
         [0.5250, 0.4750],
         [0.5247, 0.4753],
         [0.4883, 0.5117],
         [0.4836, 0.5164],
         [0.4875, 0.5125],
         [0.5246, 0.4754],
         [0.4853, 0.5147],
         [0.4876, 0.5124],
         [0.5247, 0.4753],
         [0.4884, 0.5116],
         [0.4890, 0.5110],
         [0.5247, 0.4753],
         [0.4846, 0.5154],
         [0.5247, 0.4753],
         [0.5246, 0.4754],
         [0.5247, 0.4753],
         [0.4892, 0.5108],
         [0.4853, 0.5147],
         [0.4899, 0.5101],
         [0.4841, 0.5159],
         [0.5247, 0.4753],
         [0.4905, 0.5095],
         [0.4673, 0.5327],
         [0.5246, 0.4754],
         [0.5677, 0.4323],
         [0.4856, 0.5144],
         [0.5247, 0.4753],
         [0.4878, 0.5122],
         [0.5247, 0.4753],
         [0.5259, 0.4741],
         [0.4909, 0.5091],
         [0.5004, 0.4996],
         [0.4859, 0.5141],
         [0.5247, 0.4753],
         [0.5247, 0.4753],
         [0.5247, 0.4753],
         [0.5246, 0.4754],
         [0.5246, 0.4754],
         [0.5171, 0.4829],
         [0.5247, 0.4753],
         [0.5275, 0.4725],
         [0.4877, 0.5123],
         [0.4890, 0.5110]]),
 None)</code></pre>
</div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>I prepared this post as part of my experimentation for the <a href="https://www.kaggle.com/c/g2net-gravitational-wave-detection">g2net-gravitational-wave-detection</a> competition. My goal for preparing this notebook was to design an end-to-end flow to learn about extending fastai for a custom new task and how to extend the library to work well with other libraries.</p>
<p>It took quite a long time to get my head around the low-level and mid level API in fastai.</p>
<p>Part of the reason being that I couldn‚Äôt spend much time on this competition and the other part was that there are very few resources available at this moment which provide good detail about creating custom bits using fastai‚Äôs mid-level and low-level APIs.</p>
<p>I would like to say that the effort that it took to complete this post was worth it and I came to know how powerful the modular structure of fastai is.</p>
<p>I would like to create an extension library using the code that I have developed for this post but at this moment I can‚Äôt say how soon I would be able to do it and when but stay tuned as I would keep posting my progress on this.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>